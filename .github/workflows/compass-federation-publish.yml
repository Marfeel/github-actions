on:
  workflow_call:
    inputs:
      publicPath:
        required: true
        type: string
      bucket:
        required: true
        type: string
      remote:
        type: string
        default: remoteEntry.js
      env_vars:
        description: List of environment variables to set up, given in env=value format.
        required: false
        type: string
    secrets:
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true
      FASTLY_KEY:
        required: true
      FASTLY_SERVICE:
        required: true

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - uses: actions/setup-node@v3
      with:
        node-version-file: '.nvmrc'

    - name: Set environment variables
      if: ${{ inputs.env_vars }}
      run: |
        for i in "${{ inputs.env_vars }}"
        do
          printf "%s\n" $i >> $GITHUB_ENV
        done

    - name: ðŸ“¦ Initialize
      run: npm ci

    - name: ðŸ›  Build
      run: PUBLIC_PATH=${{ inputs.publicPath }} GENERATE_SOURCEMAP=false CI= npm run build

    - name: ðŸš€ Upload to S3
      if: github.event.repository.name != 'compass-federation-template'
      run: |
        npx s3-deploy './build/**/${{ inputs.remote }}' --cwd './build/' --bucket ${{ inputs.bucket }} --cacheControl \"max-age=300,s-maxage=2592000\" --region eu-west-1
        npx s3-deploy './build/**/*' --cwd './build/' --bucket ${{ inputs.bucket }} --cacheControl \"max-age=3600,s-maxage=2592000\" --region eu-west-1
      env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    - name: ðŸš½ Purge Fastly
      if: github.event.repository.name != 'compass-federation-template'
      uses: Marfeel/github-actions/common/actions/purgeFastly@master
      with:
        fastly-key: ${{ secrets.FASTLY_KEY }}
        service-id: ${{ secrets.FASTLY_SERVICE }}
